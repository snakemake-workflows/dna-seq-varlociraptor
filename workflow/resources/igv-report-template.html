<html>

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>IGV Variant Inspector </title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5/build/vega.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@3/build/vega-lite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@4/build/vega-embed.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.0.4/math.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.19/css/dataTables.foundation.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.19/js/jquery.dataTables.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.19/js/dataTables.foundation.min.js"></script>
    <script type="text/javascript">
        $.fn.dataTable.render.ellipsis = function (cutoff, wordbreak, escapeHtml) {
            var esc = function (t) {
                return t
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;');
            };

            return function (d, type, row) {
                // Order, search and type get the original data
                if (type !== 'display') {
                    return d;
                }

                if (typeof d !== 'number' && typeof d !== 'string') {
                    return d;
                }

                d = d.toString(); // cast numbers

                if (d.length < cutoff) {
                    return d;
                }

                var shortened = d.substr(0, cutoff - 1);

                // Find the last white space character in the string
                if (wordbreak) {
                    shortened = shortened.replace(/\s([^\s]*)$/, '');
                }

                // Protect against uncontrolled HTML input
                if (escapeHtml) {
                    shortened = esc(shortened);
                }

                return '<span class="ellipsis" title="' + esc(d) + '">' + shortened + '&#8230;</span>';
            };
        };
    </script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/css/foundation.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/js/foundation.min.js"></script>
    <!-- igv -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/igv@2.2.17/dist/igv.min.js"></script>

    <style type="text/css">
        body {
            font-size: 80%;
            font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;
        }
    </style>

    <!-- selector table style -->
    <style>
        tr {
            cursor: default;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: lightblue;
        }

        th {
            background-color: #2ba6cb;
            color: white;
        }

        .selected {
            background-color: lightblue !important;
            outline: solid thin darkblue !important;
        }
    </style>

    <!-- accordian style,  ref: https://alligator.io/css/collapsible/ -->
    <style type="text/css">
        .wrap-collabsible {
            margin-bottom: 1.2rem;
        }

        input[type='checkbox'] {
            display: none;
        }

        .lbl-toggle {
            display: block;

            font-weight: bold;
            font-family: monospace;
            font-size: 1.2rem;
            text-transform: uppercase;
            text-align: left;

            padding: 1rem;

            color: black;
            background: #dddddd;

            cursor: pointer;

            border-radius: 7px;
            transition: all 0.25s ease-out;
        }

        .lbl-toggle:hover {
            color: blue;
        }

        .lbl-toggle::before {
            content: ' ';
            display: inline-block;

            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 5px solid currentColor;
            vertical-align: middle;
            margin-right: .7rem;
            transform: translateY(-2px);

            transition: transform .2s ease-out;
        }

        .toggle:checked+.lbl-toggle::before {
            transform: rotate(90deg) translateX(-3px);
        }

        .collapsible-content {
            max-height: 0px;
            overflow: auto;
            transition: max-height .25s ease-in-out;
        }

        .toggle:checked+.lbl-toggle+.collapsible-content {
            max-height: 700px;
        }

        .toggle:checked+.lbl-toggle {
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }

        .collapsible-content .content-inner {
            background: rgba(250, 224, 66, .2);
            border-bottom: 1px solid rgba(250, 224, 66, .45);
            border-bottom-left-radius: 7px;
            border-bottom-right-radius: 7px;
            padding: .5rem 1rem;
        }
    </style>

</head>

<body>
    <div class="grid-x">
        <div class="cell large-8">
            <div class="accordion" data-accordion data-allow-all-closed="true" data-multi-expand="true">
                <div class="accordion-item is-active" data-accordion-item>
                    <!-- Accordion tab title -->
                    <a href="#" class="accordion-title">Variants</a>
                    <div class="accordion-content" data-tab-content>
                        <div id="tableSelectorDiv" style="overflow: auto"></div>
                    </div>
                </div>
                <div class="accordion-item is-active" data-accordion-item>
                    <!-- Accordion tab title -->
                    <a href="#" class="accordion-title">IGV</a>
                    <div class="accordion-content" data-tab-content>
                        <div id="igvDiv"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="cell large-4">
            <div class="accordion" data-accordion data-allow-all-closed="true" data-multi-expand="true">
                <div class="accordion-item is-active" data-accordion-item>
                    <!-- Accordion tab title -->
                    <a href="#" class="accordion-title">Variant Details</a>
                    <div class="accordion-content" data-tab-content>
                        <div id="tableCommonDetailsDiv" style="overflow: auto"></div>
                        <div id="tableVariantsDetailsDiv" style="overflow: auto"></div>
                    </div>
                </div>
                <div class="accordion-item is-active" data-accordion-item>
                    <!-- Accordion tab title -->
                    <a href="#" class="accordion-title">Event probabilities</a>
                    <div class="accordion-content" data-tab-content style="overflow: auto">
                        <div id="PlotProbDiv" class="grid-x align-left"></div>
                    </div>
                </div>
                <div class="accordion-item is-active" data-accordion-item>
                    <!-- Accordion tab title -->
                    <a href="#" class="accordion-title">Allele frequency estimation</a>
                    <div class="accordion-content" data-tab-content style="overflow: auto">
                        <div id="PlotAFDiv" class="grid-x align-left"></div>
                    </div>
                </div>
                <div class="accordion-item is-active" data-accordion-item>
                    <!-- Accordion tab title -->
                    <a href="#" class="accordion-title">Observations</a>
                    <div class="accordion-content" data-tab-content style="overflow: auto">
                        <div id="PlotObservationsDiv" class="grid-x align-left"></div>
                    </div>
                </div>
                <div class="accordion-item is-active" data-accordion-item>
                    <!-- Accordion tab title -->
                    <a href="#" class="accordion-title">Functional Prediction</a>
                    <div class="accordion-content" data-tab-content style="overflow: auto">
                        <div class="accordion-item is-active" data-accordion-item>
                            <!-- Accordion tab title -->
                            <a href="#" class="accordion-title">Any Isoform</a>
                            <div class="accordion-content" data-tab-content style="overflow: auto">
                                <div id="PlotdbSNFPScoresIsoform" class="grid-x align-left"></div>
                            </div>
                        </div>
                        <div class="accordion-item is-active" data-accordion-item>
                            <!-- Accordion tab title -->
                            <a href="#" class="accordion-title">Ensembl Transcripts</a>
                            <div class="accordion-content" data-tab-content style="overflow: auto">
                                <div id="PlotsdbSNFPScoresEnsembl" class="grid-x align-left"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var tableJson = "@TABLE_JSON@"

        var sessionDictionary = "@SESSION_DICTIONARY@"

        document.addEventListener("DOMContentLoaded", function () {

            initIGV();
            initDetailsTables();
            initDataTable();
        });

        $.fn.dataTable.render.multi = function (renderArray) {
            return function (d, type, row, meta) {
                for (var r = 0; r < renderArray.length; r++) {
                    d = renderArray[r](d, type, row, meta);

                }
                return d;
            }
        }

        function initDataTable() {
            if (tableJson.length > 0) {
                var samples = Object.keys(tableJson[0]).filter(function (key) { return key.endsWith(":AF") }).map(function (entry) { return entry.slice(0, -3) })
            } else {
                var samples = []
            }
                var columns = ['Chrom', 'Position', 'ID', 'Cosmic IDs', 'Gene', 'dgiDB drugs', 'DNA alteration', 'Impact']
            var sample_columns = []
            for (sample of samples) {
                sample_columns.push(`${sample}:AF`)
                sample_columns.push(`${sample}:DP`)
            }
            columns.push(...sample_columns)
            var table = document.createElement("table");
            table.id = "variant_table"
            document.getElementById("tableSelectorDiv").appendChild(table);

            var thead = document.createElement('thead');
            table.appendChild(thead);

            var headerRow = thead.insertRow(0);
            for (column of columns) {
                var cell = document.createElement("th");
                headerRow.appendChild(cell);
                cell.innerHTML = column;
            }
            var data = []
            for (column of ['CHROM', 'POSITION']) {
                data.push({ data: column })
            }
            for (column of ['ID', 'cosmic_LEGACY_ID', 'GENE', 'dgiDB_drugs', 'DNA ALTERATION', 'IMPACT']) {
                if (column == 'dgiDB_drugs') {
                    data.push({ data: 'dgiDB_drugs', render: $.fn.dataTable.render.multi([parse_dgidb_data, $.fn.dataTable.render.ellipsis(15, true)]) })
                } else {
                    data.push({ data: column, render: $.fn.dataTable.render.multi([parse_column_data, $.fn.dataTable.render.ellipsis(15, true)]) })
                }
            }
            for (column of sample_columns) {
                data.push({ data: column })
            }

            $('#variant_table').DataTable({
                data: tableJson,
                columns: data,
                ordering: true,
            });
        }

        function parse_dgidb_data(data) {
            if (data == undefined) {
                return ""
            }
            var parsed_drugs = []
            var entries = data.split(",").map(row => row.split("|")[1])
            entries = entries.filter(function (entry) { return entry != '.' })
            const unique_entries = [...new Set(entries)]
            return unique_entries.join(', ')
        }

        function parse_column_data(data) {
            if (data == undefined) {
                return ""
            }
            var parsed_ids = []
            var entries = data.split(/[,\|]/)
            entries = entries.filter(function (entry) { return entry != '.' })
            const unique_entries = [...new Set(entries)]
            return unique_entries.join(', ')
        }

        function initDetailsTables() {
            var table_ids = {
                "common_details_table": "tableCommonDetailsDiv",
                "variant_details_table": "tableVariantsDetailsDiv"
            }
            $.each(table_ids, function (table_id, table_div) {
                var table = document.createElement("table");
                table.setAttribute("class", "unstriped")
                table.id = table_id
                document.getElementById(table_div).appendChild(table);
                var tbody = document.createElement('tbody');
                table.appendChild(tbody);
            })
            createPlotCell("PlotProbDiv", "Prob");
            createPlotCell("PlotAFDiv", "AlleleFreq");
            createPlotCell("PlotObservationsDiv", "Obs");
            createPlotCell("PlotdbSNFPScoresIsoform", "dbNSFP_Isoform");
            createPlotCell("PlotsdbSNFPScoresEnsembl", "dbNSFP_Ensembl_scores")
        }


        function addCommonDetailsRow(key, value) {
            var tbody = document.getElementById("common_details_table_tbody")
            var row = document.createElement("tr");
            tbody.appendChild(row);
            cell_key = document.createElement("td");
            row.appendChild(cell_key);
            var key_readable = key.charAt(0).toUpperCase() + key.substring(1).toLowerCase().replace(/_/g, "-");
            cell_key.innerHTML = key_readable;
            var cell_value = document.createElement("td");
            row.appendChild(cell_value)
            if (key_readable == "Cosmic-legacy-id") {
                var cosmic_ids = new Set(value.split(","))
                for (cosmic_id of cosmic_ids) {
                    var cosmic_number = cosmic_id.substring(4)
                    createLink(cell_value, `https://cancer.sanger.ac.uk/cosmic/mutation/overview?id=${cosmic_number}`, cosmic_id)
                }
            } else if (key_readable == "Id") {
                var ids = new Set(value.split(","))
                for (id of ids) {
                    if (id.startsWith("rs")) {
                        createLink(cell_value, `https://www.ensembl.org/Multi/Search/Results?q=${id}`, id)
                    }
                }
            } else {
                cell_value.innerHTML = value
            }
        }

        function addVariantDetailsRow(key, value) {
            var tbody = document.getElementById("variant_details_table_tbody")
            var row = document.createElement("tr");
            row.id = "row_" + key
            tbody.appendChild(row);
            cell_key = document.createElement("td");
            row.appendChild(cell_key);
            var key_readable = key.charAt(0).toUpperCase() + key.substring(1).toLowerCase().replace(/_/g, "-");
            cell_key.innerHTML = key_readable;
            $.each(value.split(","), function (idx, variant_value) {
                var cell_value = document.createElement("td");
                cell_value.id = idx
                row.appendChild(cell_value);
                if (key_readable == "Effects") {
                    variant_value = `<a href='http://snpeff.sourceforge.net/VCFannotationformat_v1.0.pdf', target="_blank">${variant_value}</a>`
                }
                cell_value.innerHTML = variant_value;
            })
        }

        function initEmptyDetailsRow(row_name) {
            var tbody = document.getElementById("variant_details_table_tbody")
            var row = document.createElement("tr")
            tbody.appendChild(row)
            cell_key = document.createElement("td")
            row.appendChild(cell_key)
            cell_key.innerHTML = row_name
            return row
        }

        function addLinkoutsRow(ensembl_ids) {
            var row = initEmptyDetailsRow("Linkouts")
            var genes = document.getElementById("row_GENE").getElementsByTagName("td")
            var alts_dna = document.getElementById("row_DNA ALTERATION").getElementsByTagName("td")
            var alts_aa = document.getElementById("row_PROTEIN ALTERATION").getElementsByTagName("td")
            var nbr_variants = genes.length
            for (i = 1; i < nbr_variants; i++) {
                var cell = document.createElement("td")
                row.appendChild(cell)
                var gene = genes[i].innerHTML
                var alt_dna = alts_dna[i].innerHTML
                var alt_aa = alts_aa[i].innerHTML
                createLink(cell, `https://clinicaltrials.gov/ct2/results?cond=&term=${gene}&cntry=&state=&city=&dist=`, "ClinicalTrials")
                createLink(cell, `https://www.cbioportal.org/ln?q=${gene}`, "cBioPortal")
                createLink(cell, `https://oncokb.org/gene/${gene}`, "OncoKB")
                createLink(cell, `https://www.ensembl.org/homo_sapiens/Gene/Summary?db=core;g=${ensembl_ids[i - 1]}`, "Ensembl")
                createLink(cell, `https://www.google.com/search?q=${gene}&as_epq=${alt_dna}`, "Google (DNA)")
                createLink(cell, `https://www.google.com/search?q=${gene}&as_epq=${alt_aa}`, "Google (Protein)")
                createLink(cell, `https://scholar.google.de/scholar?hl=de&as_sdt=0%2C5&q=${gene}+"${alt_dna}"`, "Google Scholar (DNA)")
                createLink(cell, `https://scholar.google.de/scholar?hl=de&as_sdt=0%2C5&q=${gene}+"${alt_aa}"`, "Google Scholar (Protein)")
            }
        }

        function addDgidbLinkouts(genes, interaction_drugs_dict) {
            var row = initEmptyDetailsRow("DGIdb Drugs")
            for (gene of genes) {
                var cell = document.createElement("td")
                row.appendChild(cell)
                if (gene in interaction_drugs_dict) {
                    for (drug of Object.keys(interaction_drugs_dict[gene])) {
                        if (drug != '.') {
                            var link = `http://dgidb.org/drugs/${drug}`
                            var type_entries = interaction_drugs_dict[gene][drug].filter(function (entry) { return entry != '.' })
                            var entries_string = ""
                            if (type_entries.length > 0) {
                                entries_string = ` (${type_entries.join(", ")})`
                            }
                            var link_string = `${drug}${entries_string}`
                            createLink(cell, link, link_string)
                        }
                    }
                }
            }
        }

        function createLink(cell, hyperlink, name) {
            var link_tag = document.createElement("a")
            link_tag.setAttribute("href", hyperlink)
            link_tag.setAttribute("target", "_blank")
            cell.appendChild(link_tag)
            var drug_text = document.createTextNode(name)
            link_tag.appendChild(drug_text)
            var break_line = document.createElement("br")
            cell.appendChild(break_line)
        }

        function initIGV() {
            var igvDiv;
            igvDiv = document.getElementById("igvDiv");
            var options = {
                sessionURL: sessionDictionary["0"],
                showChromosomeWidget: false,
                showCenterGuide: true
            };

            igv.createBrowser(igvDiv, options)
                .then(function (b) {
                    igv.browser = b;
                })
        }

        function calcBinomDist(alleleFreq, coverage, sample_type) {
            var binomValues = [];
            var frequency = 0;
            var k = Math.round(alleleFreq * coverage);
            while (frequency <= 1) {
                var value = math.combinations(coverage, k) * Math.pow(frequency, k) * Math.pow((1 - frequency), (coverage - k))
                binomValues.push({
                    "frequency": frequency,
                    "binomProb": value,
                    "sample": sample_type
                });
                frequency += 0.01;
            }
            return binomValues;
        }

        function reinitalize_table(table_id) {
            $('#' + table_id + ' tbody').remove()
            var table = document.getElementById(table_id)
            var tbody = document.createElement('tbody');
            tbody.setAttribute("id", table_id + "_tbody");
            table.appendChild(tbody);
        }

        function parse_interaction_drugs(init_row) {
            var interaction_drugs_dict = {}
            init_row.split(",").forEach(
                res => {
                    var [gene, drug, interaction_type] = res.split("|")
                    if (!(gene in interaction_drugs_dict)) {
                        interaction_drugs_dict[gene] = {}
                    }
                    if (!(drug in interaction_drugs_dict[gene])) {
                        interaction_drugs_dict[gene][drug] = []
                    }
                    interaction_drugs_dict[gene][drug].push(interaction_type)
                }
            )
            return interaction_drugs_dict
        }


        dbnsfp_thresholds = {}
        dbnsfp_thresholds["REVEL"] = { "Probability": [0, 1] }
        dbnsfp_thresholds["MutPred"] = { "Probability": [0, 1] }
        dbnsfp_thresholds["LRT"] = { "p-value": [0, 1] }
        dbnsfp_thresholds["VEST4"] = { "p-value": [0, 1] }
        dbnsfp_thresholds["MetaSVM"] = { "Tolerated": [-2, -0.001], "Damaging": [0, 3] }
        dbnsfp_thresholds["MetaLR"] = { "Tolerated": [0, 0.549], "Damaging": [0.5, 1] }
        dbnsfp_thresholds["M_CAP"] = { "Tolerated": [0, 0.0249], "Damaging": [0.025, 1] }
        dbnsfp_thresholds["PrimateAI"] = { "Tolerated": [0, 0.802], "Damaging": [0.803, 1] }
        dbnsfp_thresholds["DEOGEN2"] = { "Tolerated": [0, 0.499], "Damaging": [0.5, 1] }
        dbnsfp_thresholds["MutationAssessor"] = { "Neutral": [-5.17, 0.799], "Low": [0.8, 1.9349], "Medium": [1.935, 3.499], "High": [3.5, 6.49] }
        dbnsfp_thresholds["Polyphen2_HDIV"] = { "Benign": [0, 0.452], "Possibly Damaging": [0.453, 0.956], "Probably Damaging": [0.957, 1] }
        dbnsfp_thresholds["Polyphen2_HVAR"] = { "Benign": [0, 0.446], "Possibly Damaging": [0.447, 0.908], "Probably Damaging": [0.909, 1] }
        dbnsfp_thresholds["FATHMM"] = { "Tolerated": [-1.49, 10.64], "Damaging": [-16.13, -1.5] }
        dbnsfp_thresholds["PROVEAN"] = { "Tolerated": [-2.49, 14], "Damaging": [-14, -2.5] }
        dbnsfp_thresholds["SIFT"] = { "Tolerated": [0.05, 1], "Damaging": [0, 0.0499] }
        dbnsfp_thresholds["SIFT4G"] = { "Tolerated": [0.05, 1], "Damaging": [0, 0.0499] }
        dbnsfp_thresholds["MVP"] = { "Tolerated": [0, 0.7], "Damaging": [0.701, 1] }
        dbnsfp_thresholds["MutationTaster"] = { "Tolerated": [0, 0.499], "Damaging": [0.5, 1] }

        dbnsfp_groups_scales = {}
        dbnsfp_groups_scales["TD"] = { "colors": ["#2ba6cb", "#ff5555"], "entries": ["Tolerated", "Damaging"] }
        dbnsfp_groups_scales["NLMH"] = { "colors": ["#2ba6cb", "#afdfee", "#ffa3a3", "#ff5555"], "entries": ["Neutral", "Low", "Medium", "High"] }
        dbnsfp_groups_scales["BPP"] = { "colors": ["#2ba6cb", "#ffa3a3", "#ff5555"], "entries": ["Benign", "Possibly Damaging", "Probably Damaging"] }
        dbnsfp_groups_scales["p-value"] = { "colors": ["#000000"], "entries": ["p-value"] }
        dbnsfp_groups_scales["Probability"] = { "colors": ["#000000"], "entries": ["Probability"] }

        dbnsfp_groups = {}
        for (name of ["MetaSVM", "MetaLR", "M_CAP", "PrimateAI", "DEOGEN2", "FATHMM", "PROVEAN", "SIFT", "SIFT4G", "MVP", "MutationTaster"]) {
            dbnsfp_groups[name] = "TD"
        }
        for (name of ["Polyphen2_HDIV", "Polyphen2_HVAR"]) {
            dbnsfp_groups[name] = "BPP"
        }
        for (name of ["REVEL", "MutPred"]) {
            dbnsfp_groups[name] = "Probability"
        }
        for (name of ["VEST4", "LRT"]) {
            dbnsfp_groups[name] = "p-value"
        }
        dbnsfp_groups["MutationAssessor"] = "NLMH"

        function build_effect_bins(name, score) {
            var effects = dbnsfp_thresholds[name]
            var effect_bins = []
            if ((Object.keys(effects).length == 1) || score == 0) {
                var effect = extract_dbnsfp_effect(name, score)
                effect_bins.push({ "effect": effect, "size": score })
            } else {
                var score_greater_zero = (score, left_boundary, right_boundary) => {
                    if (score < right_boundary) {
                        return (left_boundary > 0) ? (score - left_boundary) : score
                    } else {
                        return (left_boundary > 0) ? (right_boundary - left_boundary) : right_boundary
                    }
                }
                var score_less_zero = (score, left_boundary, right_boundary) => {
                    if (score > left_boundary) {
                        return (right_boundary < 0) ? (score - right_boundary) : score
                    } else {
                        return (right_boundary < 0) ? (left_boundary - right_boundary) : left_boundary
                    }
                }
                for (var effect in effects) {
                    var effect_boundarys = effects[effect]
                    if (score > 0) {
                        if ((effect_boundarys[1] > 0) && (score > effect_boundarys[0])) {
                            var size = score_greater_zero(score, effect_boundarys[0], effect_boundarys[1])
                            effect_bins.push({ "effect": effect, "size": size })
                        }
                    } else if (score < 0) {
                        if ((effect_boundarys[0] < 0) && (score < effect_boundarys[1])) {
                            var size = score_less_zero(score, effect_boundarys[0], effect_boundarys[1])
                            effect_bins.push({ "effect": effect, "size": size })
                        }
                    } else {
                        alert(`Value error: ${score}`)
                    }
                }
            }
            return effect_bins
        }

        function extract_dbnsfp_effect(name, value) {
            if (!(name in dbnsfp_thresholds)) {
                return "Effect not found"
            }
            var effects = dbnsfp_thresholds[name]
            for (var key in effects) {
                if ((value >= effects[key][0]) && (value <= effects[key][1])) {
                    return key
                }
            }
            return "Score out of range"
        }


        $(document).ready(function () {
            const zip = (arr1, arr2) => arr1.map((k, i) => [k, arr2[i]])
            var var_table = $('#variant_table').DataTable();
            var variant_columns = ["GENE", "EFFECTS", "IMPACT", "TRANSCRIPT", "PROTEIN ALTERATION", "DNA ALTERATION"]
            var skip_entries = ["unique_id", "dgiDB_drugs", 'GENE_ID']
            $('#variant_table tbody').on('click', 'tr', function () {
                var_table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
                var row_idx = var_table.row(this).index();
                // Set igv
                var session = sessionDictionary[row_idx]
                igv.browser.loadSession({
                    url: session
                })

                // Replace detail table by new row content
                reinitalize_table("common_details_table")
                reinitalize_table("variant_details_table")
                var init_row = tableJson[row_idx]
                var ensembl_ids = null
                if ("dbNSFP_Ensembl_transcriptid" in init_row) {
                    ensembl_ids = init_row["dbNSFP_Ensembl_transcriptid"].split(",")
                }
                var isoform_score_names = ["MetaSVM", "MetaLR", "M_CAP", "REVEL", "MutPred", "PrimateAI", "LRT"]
                var observations = [];
                var probabilites = [];
                var binom_dist = [];
                var coverage = {};
                var dbnsfp_isoform_scores = {}
                var dbnsfp_transcript_scores = {}
                var regex = /([0-9]+)(N|B|P|S|V|n|b|p|s|v)(\+|\-|\*)/g;
                var effects = {
                    "N": "None",
                    "B": "Barely",
                    "P": "Positive",
                    "S": "Strong",
                    "V": "Very Strong"
                }
                var nucleotides = { "A": 1, "C": 2, "G": 3, "T": 4 }
                var ref_nc = -1
                var interaction_drugs_dict = parse_interaction_drugs(init_row["dgiDB_drugs"])
                var dbnsfp_excluded = ["MPC", "SIFT", "SIFT4G"] //TODO: Implementation of SIFT(4G) ranges
                $.each(init_row, function (key, value) {
                    if (skip_entries.includes(key)) {
                        //pass
                    } else if (key.endsWith(':OBS')) {
                        var type = key.charAt(0).toUpperCase() + key.replace(":OBS", "").substring(1);
                        while ((result = regex.exec(value)) != null) {

                            strand = result[3].replace("*", "±")
                            effect = effects[result[2].toUpperCase()]
                            var quality = "Low mapping quality";
                            if (result[2] == result[2].toUpperCase()) {
                                quality = "High mappping quality";
                            }
                            observations.push({
                                "type": type,
                                "strand": strand,
                                "effect": effect,
                                "times": parseFloat(result[1]),
                                "Quality": quality
                            })
                        }
                    } else if (key.startsWith('PROB_')) {
                        var prob_type = key.replace("PROB_", "");
                        prob_type = prob_type.charAt(0) + prob_type.substring(1).toLowerCase().replace("_", " ");
                        var probability = Math.pow(10, (-1 * parseFloat(value) / 10));
                        probabilites.push({
                            "prob_type": prob_type,
                            "prob": probability
                        })
                        addCommonDetailsRow(key, probability.toFixed(4));
                    } else if (key.endsWith(":DP")) {
                        coverage[key] = parseFloat(value)
                    } else if (key.endsWith(":AF")) {
                        sample_type = key.replace(":AF", "")
                        binom_dist = binom_dist.concat(calcBinomDist(parseFloat(value), coverage[sample_type + ":DP"], sample_type));
                    } else if (variant_columns.includes(key)) {
                        addVariantDetailsRow(key, value)
                    } else if (key.startsWith("dbNSFP")) {
                        var name = key.substring(7, key.length - 6)
                        if (isoform_score_names.includes(name)) {
                            var group = dbnsfp_groups[name]
                            if (!(group in dbnsfp_isoform_scores)) {
                                dbnsfp_isoform_scores[group] = []
                            }
                            if (!(value == "None")) {
                                var effect_bins = build_effect_bins(name, parseFloat(value))
                                for (bin of effect_bins) {
                                    var effect_idx = dbnsfp_groups_scales[group]["entries"].indexOf(bin.effect)
                                    dbnsfp_isoform_scores[group].push({
                                        "name": name,
                                        "size": bin.size,
                                        "effect": bin.effect,
                                        "effect_idx": effect_idx
                                    })
                                }
                            } else {
                                var effect = extract_dbnsfp_effect(name, value)
                                var effect_idx = dbnsfp_groups_scales[group]["entries"].indexOf(effect)
                                dbnsfp_isoform_scores[group].push({
                                    "name": name,
                                    "size": value,
                                    "effect": effect,
                                    "effect_idx": effect_idx
                                })
                            }
                        } else if (key.endsWith("score") && (!dbnsfp_excluded.includes(name))) {
                            var values = value.split(",")
                            if (ensembl_ids.length == values.length) {
                                for (entry_pair of zip(ensembl_ids, values)) {
                                    var group = dbnsfp_groups[name]
                                    if (!(group in dbnsfp_transcript_scores)) {
                                        dbnsfp_transcript_scores[group] = []
                                    }
                                    if (!(entry_pair[1] == "None")) {
                                        var effect_bins = build_effect_bins(name, parseFloat(entry_pair[1]))
                                        for (bin of effect_bins) {
                                            var effect_idx = dbnsfp_groups_scales[group]["entries"].indexOf(bin.effect)
                                            dbnsfp_transcript_scores[group].push({
                                                "name": name,
                                                "size": bin.size,
                                                "effect": bin.effect,
                                                "effect_idx": effect_idx,
                                                "ensemblId": entry_pair[0]
                                            })
                                        }
                                    } else {
                                        var effect = extract_dbnsfp_effect(name, entry_pair[1])
                                        var effect_idx = dbnsfp_groups_scales[group]["entries"].indexOf(bin.effect)
                                        dbnsfp_transcript_scores[group].push({
                                            "name": name,
                                            "size": entry_pair[1],
                                            "effect": effect,
                                            "effect_idx": effect_idx,
                                            "ensemblId": entry_pair[0]
                                        })
                                    }
                                }
                            }
                        }
                    } else if (key == "cosmic_LEGACY_ID") {
                        addCommonDetailsRow(key, value)
                    } else if (key == "ID") {
                        addCommonDetailsRow(key, value)
                    } else {
                        if (key == "REF") {
                            ref_nc = nucleotides[value]
                        }
                        addCommonDetailsRow(key, value)
                    }
                })
                addLinkoutsRow(init_row['GENE_ID'].split(','))
                addDgidbLinkouts(init_row["GENE"].split(','), interaction_drugs_dict)

                //Plot Binomial Distribution
                $("#AlleleFreq").empty()
                var distSpec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
                    "data": {
                        values: binom_dist
                    },
                    "mark": {
                        "type": "line",
                        "interpolate": "linear"
                    },
                    "encoding": {
                        "column": {
                            "field": "sample",
                            "type": "ordinal",
                            "title": "Sample"
                        },
                        "x": {
                            "field": "frequency",
                            "type": "quantitative",
                            "title": "Frequency"
                        },
                        "y": {
                            "field": "binomProb",
                            "type": "quantitative",
                            "title": "Density"
                        }
                    }
                };
                vegaEmbed('#AlleleFreq', distSpec);


                //Plot probabilites
                $("#Prob").empty()
                var probSpec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
                    "data": {
                        values: probabilites
                    },
                    "spacing": 20,
                    "hconcat": [{
                        "transform": [{
                            "calculate": "datum.prob < 0.01 ? 1 : 0",
                            "as": "alpha"
                        },
                        {
                            "calculate": "datum.prob < 0.01 ? datum.prob : 0.01",
                            "as": "prob"
                        }
                        ],
                        "mark": "circle",
                        "title": null,
                        "encoding": {
                            "y": {
                                "field": "prob_type",
                                "type": "nominal",
                                "title": null,
                                "axis": {
                                    "title": false
                                },
                                "sort": "ascending"
                            },
                            "x": {
                                "field": "prob",
                                "type": "quantitative",
                                "title": "Probability",
                                "scale": {
                                    "type": "log"
                                }
                            },
                            "color": {
                                "type": "nominal",
                                "field": "alpha",
                                "scale": {
                                    "domain": [0, 1],
                                    "range": ["#00000000", "#32a852"]
                                },
                                "legend": null
                            },
                            "tooltip": [{
                                "field": "prob_type",
                                "type": "nominal",
                                "title": "Type"
                            }, {
                                "field": "prob",
                                "type": "quantitative",
                                "title": "Probability"
                            }]
                        }
                    },
                    {
                        "transform": [{
                            "calculate": "datum.prob >= 0.01 ? 1 : 0",
                            "as": "alpha"
                        },
                        {
                            "calculate": "datum.prob >= 0.01 ? datum.prob : 0.01",
                            "as": "prob"
                        }
                        ],
                        "mark": "circle",
                        "encoding": {
                            "y": {
                                "field": "prob_type",
                                "type": "nominal",
                                "axis": null,
                                "sort": "ascending"
                            },
                            "x": {
                                "field": "prob",
                                "type": "quantitative",
                                "title": "Probability",
                                "scale": {
                                    "type": "log"
                                }
                            },
                            "color": {
                                "type": "nominal",
                                "field": "alpha",
                                "scale": {
                                    "domain": [0, 1],
                                    "range": ["#00000000", "#32a852"]
                                },
                                "legend": null
                            },
                            "tooltip": [{
                                "field": "prob_type",
                                "type": "nominal",
                                "title": "Type"
                            }, {
                                "field": "prob",
                                "type": "quantitative",
                                "title": "Probability"
                            }]
                        }
                    }
                    ],
                    "config": {
                        "view": {
                            "stroke": null
                        },
                        "axis": {
                            "grid": false
                        },
                        "concat": {
                            "spacing": 40
                        }
                    },
                    "encoding": {
                        "tooltip": [{
                            "field": "prob_type",
                            "type": "nominal",
                            "title": "Type"
                        }, {
                            "field": "prob",
                            "type": "quantitative",
                            "title": "Probability"
                        }]
                    }
                };
                vegaEmbed('#Prob', probSpec);

                //Add observations
                $("#Obs").empty()
                var obsSpec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
                    "data": {
                        values: observations
                    },
                    "mark": "bar",
                    "encoding": {
                        "column": {
                            "field": "type",
                            "type": "ordinal",
                            "title": "Sample"
                        },
                        "row": {
                            "field": "Quality",
                            "type": "ordinal",
                            "title": null
                        },
                        "x": {
                            "field": "strand",
                            "type": "ordinal",
                            "title": "Strand"
                        },
                        "y": {
                            "field": "times",
                            "type": "quantitative",
                            "title": "Counts"
                        },
                        "color": {
                            "field": "effect",
                            "type": "nominal",
                            "title": "Evidence",
                            "sort": ["None", "Barely", "Positive", "Strong", "Very Strong"],
                            "scale": {
                                "domain": ["None", "Barely", "Positive", "Strong", "Very Strong"],
                                "range": ["#999999", "#2ba6cb", "#afdfee", "#ffa3a3", "#ff5555"]
                            }
                        }
                    },
                    "config": {
                        "axisX": {
                            "labelAngle": 0
                        }
                    }
                };
                vegaEmbed('#Obs', obsSpec);

                var score_transformation = (g) => { if (g == "p-value") { return "-10 * log(datum.size + (1e-15))/log(10)" } else { return "datum.size" } }
                var score_title = (g) => {
                    if (g == "p-value") {
                        return "p-value (PHRED-scaled)"
                    } else if (g == "Probability") {
                        return "Probability"
                    } else {
                        return "Score"
                    }
                }
                var score_legend = (g) => {
                    if ((g == "p-value") || (g == "Probability")) {
                        return ""
                    } else {
                        return "effect"
                    }
                }

                $("#dbNSFP_Isoform").empty()
                if (Object.keys(dbnsfp_isoform_scores).length > 0) {
                    for (var group in dbnsfp_isoform_scores) {
                        var rowId = `dbnsfp_isoforms_${group}`
                        addPlotCellRow("dbNSFP_Isoform", rowId)
                        var IsoformSpec = {
                            "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
                            "data": {
                                values: dbnsfp_isoform_scores[group]
                            },
                            "transform": [{ "calculate": score_transformation(group), "as": "transformed_score" }],
                            "mark": "bar",
                            "encoding": {
                                "y": {
                                    "field": "name",
                                    "type": "nominal",
                                    "title": "Type"
                                },
                                "x": {
                                    "field": "transformed_score",
                                    "type": "quantitative",
                                    "title": score_title(group),
                                },
                                "color": {
                                    "field": score_legend(group),
                                    "type": "nominal",
                                    "title": "Effect",
                                    "sort": dbnsfp_groups_scales[group]["entries"],
                                    "scale": {
                                        "domain": dbnsfp_groups_scales[group]["entries"],
                                        "range": dbnsfp_groups_scales[group]["colors"]
                                    }
                                },
                                "order": { "field": "effect_idx", "type": "quantitative" },
                                "tooltip": null
                            },
                            "config": {
                                "axisX": {
                                    "labelAngle": 90
                                }
                            }
                        };
                        vegaEmbed(`#${rowId}`, IsoformSpec)
                    }
                }

                $("#dbNSFP_Ensembl_scores").empty()
                if (Object.keys(dbnsfp_transcript_scores).length > 0) {
                    for (var group in dbnsfp_transcript_scores) {
                        var rowId = `dbnsfp_transcripts_${group}`
                        addPlotCellRow("dbNSFP_Ensembl_scores", rowId)
                        var dbNSFPSpec = {
                            "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
                            "data": {
                                values: dbnsfp_transcript_scores[group]
                            },
                            "transform": [{ "calculate": score_transformation(group), "as": "transformed_score" }],
                            "facet": {
                                "column": {
                                    "field": "ensemblId",
                                    "type": "nominal",
                                    "title": "EnsemblID"
                                }
                            },
                            "spec": {
                                "mark": "bar",
                                "encoding": {
                                    "y": {
                                        "field": "name",
                                        "type": "nominal",
                                        "title": "Type"
                                    },
                                    "x": {
                                        "field": "transformed_score",
                                        "type": "quantitative",
                                        "title": score_title(group),
                                    },
                                    "color": {
                                        "field": score_legend(group),
                                        "type": "nominal",
                                        "title": "Effect",
                                        "sort": dbnsfp_groups_scales[group]["entries"],
                                        "scale": {
                                            "domain": dbnsfp_groups_scales[group]["entries"],
                                            "range": dbnsfp_groups_scales[group]["colors"]
                                        }
                                    },
                                    "order": { "field": "effect_idx", "type": "quantitative" },
                                    "tooltip": null
                                }
                            },
                            "config": {
                                "axisX": {
                                    "labelAngle": 90
                                }
                            }
                        };
                        vegaEmbed(`#${rowId}`, dbNSFPSpec)
                    }
                }
            });
        });


        function createPlotCell(divId, cellId) {
            var cell = document.createElement("div");
            var table = document.createElement("table")
            table.setAttribute("class", "unstriped")
            var tbody = document.createElement("tbody")
            tbody.setAttribute("id", cellId)
            table.appendChild(tbody)
            cell.appendChild(table)
            document.getElementById(divId).appendChild(cell);
        }

        function addPlotCellRow(cellId, rowId) {
            var row = document.createElement("tr")
            var cell = document.createElement("td")
            cell.setAttribute("id", rowId)
            row.appendChild(cell)
            document.getElementById(cellId).appendChild(row)
        }

        $(document).foundation()
    </script>
</body>

</html>